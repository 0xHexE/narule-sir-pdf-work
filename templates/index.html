<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Federated Learning Task Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/style.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-brain me-2"></i>Federated Learning Monitor
            </a>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-cogs me-2"></i>Start New Task
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="taskForm">
                            <div class="mb-3">
                                <label class="form-label">Strategy Type</label>
                                <select class="form-select" id="strategyType" required>
                                    <option value="adaptive">Adaptive Selection</option>
                                    <option value="top_k">Top-K Selection</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Number of Rounds</label>
                                <input type="number" class="form-control" id="numRounds" value="2" min="1" required>
                            </div>
                            
                            <div id="topKParams" class="mb-3" style="display: none;">
                                <label class="form-label">K Value (number of clients)</label>
                                <input type="number" class="form-control" id="kValue" value="3" min="1">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Metric</label>
                                <select class="form-select" id="metric">
                                    <option value="accuracy">Accuracy</option>
                                    <option value="loss">Loss</option>
                                </select>
                            </div>
                            
                            <div id="adaptiveParams" class="mb-3">
                                <label class="form-label">Selection Ratio</label>
                                <input type="number" class="form-control" id="selectionRatio" value="0.5" min="0.1" max="1.0" step="0.1">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Server Port</label>
                                <input type="number" class="form-control" id="serverPort" value="8787" min="1024" max="65535" required>
                                <small class="form-text text-muted">Port number where the federated learning server will listen (1024-65535)</small>
                            </div>
                            
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-play me-2"></i>Start Task
                            </button>
                        </form>
                    </div>
                </div>
                
                <div class="card mt-4">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-chart-line me-2"></i>Metrics Overview
                        </h6>
                    </div>
                    <div class="card-body">
                        <div id="metricsOverview" class="metrics-chart d-flex align-items-center justify-content-center">
                            <span class="text-muted">No metrics data available</span>
                        </div>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-compress-alt me-2"></i>Compare Tasks
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Select Tasks to Compare (2-4 tasks)</label>
                            <select class="form-select" id="compareTasks" multiple size="4">
                                <!-- Task options will be populated dynamically -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Metric to Compare</label>
                            <select class="form-select" id="compareMetric">
                                <option value="accuracy">Accuracy</option>
                                <option value="loss">Loss</option>
                            </select>
                        </div>
                        <button class="btn btn-outline-primary w-100" onclick="compareSelectedTasks()">
                            <i class="fas fa-chart-bar me-2"></i>Compare Selected Tasks
                        </button>
                    </div>
                </div>

                <div class="card mt-4" id="comparisonResults" style="display: none;">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-chart-bar me-2"></i>Comparison Results
                        </h6>
                    </div>
                    <div class="card-body">
                        <div id="comparisonChartContainer" style="height: 300px;">
                            <canvas id="comparisonChart"></canvas>
                        </div>
                        <div id="comparisonStats" class="mt-3"></div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-9">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>
                        <i class="fas fa-tasks me-2"></i>Task History
                    </h2>
                    <button class="btn btn-outline-secondary" onclick="refreshTasks()">
                        <i class="fas fa-sync-alt me-2"></i>Refresh
                    </button>
                </div>

                <div id="tasksList" class="row">
                    <div class="col-12">
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                            <p>Loading tasks...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Details Modal -->
    <div class="modal fade" id="taskModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Task Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="taskDetails">
                    <!-- Task details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-danger" onclick="deleteTask()">
                        <i class="fas fa-trash me-2"></i>Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let currentTaskId = null;
        let metricsChart = null;
        let taskMetricsChart = null;
        let comparisonChart = null;
        let allTasks = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadTasks();
            loadMetrics();
            
            // Show/hide strategy-specific parameters
            document.getElementById('strategyType').addEventListener('change', function() {
                const strategyType = this.value;
                document.getElementById('topKParams').style.display = strategyType === 'top_k' ? 'block' : 'none';
                document.getElementById('adaptiveParams').style.display = strategyType === 'adaptive' ? 'block' : 'none';
            });
            
            // Form submission
            document.getElementById('taskForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await startTask();
            });
            
            // Auto-refresh every 10 seconds
            setInterval(loadTasks, 10000);
        });

        async function loadTasks() {
            try {
                const response = await fetch('/api/tasks');
                const data = await response.json();
                displayTasks(data.tasks);
            } catch (error) {
                console.error('Error loading tasks:', error);
            }
        }

        async function loadMetrics() {
            try {
                const response = await fetch('/api/metrics');
                const data = await response.json();
                updateMetricsChart(data.metrics);
            } catch (error) {
                console.error('Error loading metrics:', error);
            }
        }

        async function loadTaskMetrics(taskId) {
            try {
                const response = await fetch(`/api/task/${taskId}/metrics`);
                const data = await response.json();
                return data.metrics;
            } catch (error) {
                console.error('Error loading task metrics:', error);
                return [];
            }
        }

        function displayTasks(tasks) {
            const container = document.getElementById('tasksList');
            allTasks = tasks; // Store tasks for comparison
            
            if (tasks.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-inbox fa-2x mb-3"></i>
                            <p>No tasks found</p>
                        </div>
                    </div>
                `;
                
                // Clear comparison dropdown
                document.getElementById('compareTasks').innerHTML = '';
                return;
            }

            container.innerHTML = tasks.map(task => {
                const statusClass = task.status;
                const timestamp = task.data.completed_at || task.data.failed_at;
                const date = timestamp ? new Date(timestamp * 1000).toLocaleString() : 'N/A';
                
                return `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card task-card ${statusClass}" onclick="showTaskDetails('${task.id}')">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <span class="badge bg-${getStatusColor(task.status)} status-badge">
                                        ${task.status.toUpperCase()}
                                    </span>
                                    <small class="text-muted">${date}</small>
                                </div>
                                <h6 class="card-title">${getStrategyDisplayName(task.data)}</h6>
                                <p class="card-text text-muted small">
                                    ID: ${task.id}<br>
                                    Rounds: ${task.data.rounds_completed || 'N/A'}<br>
                                    ${task.data.error ? `Error: ${task.data.error}` : ''}
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Update comparison dropdown
            updateComparisonDropdown(tasks);
        }

        function getStrategyDisplayName(taskData) {
            // For completed tasks, use strategy_used
            if (taskData.strategy_used) {
                return taskData.strategy_used;
            }
            
            // For running tasks, use strategy_type and format it
            if (taskData.strategy_type) {
                const strategyMap = {
                    'top_k': 'Top-K Selection',
                    'adaptive': 'Adaptive Selection',
                    'default': 'Default Strategy'
                };
                return strategyMap[taskData.strategy_type] || taskData.strategy_type;
            }
            
            return 'Unknown Strategy';
        }

        function getStatusColor(status) {
            switch(status) {
                case 'completed': return 'success';
                case 'running': return 'warning';
                case 'failed': return 'danger';
                case 'pending': return 'secondary';
                default: return 'secondary';
            }
        }

        async function showTaskDetails(taskId) {
            currentTaskId = taskId;
            try {
                const response = await fetch(`/api/task/${taskId}`);
                const task = await response.json();
                
                const modalBody = document.getElementById('taskDetails');
                
                // Load metrics to display in the modal
                let metricsHtml = '';
                let chartHtml = '';
                try {
                    const taskMetrics = await loadTaskMetrics(taskId);
                    
                    if (taskMetrics && taskMetrics.length > 0) {
                        const latestRound = taskMetrics[taskMetrics.length - 1];
                        metricsHtml = `
                            <div class="mt-3">
                                <h6>Latest Metrics</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card bg-light">
                                            <div class="card-body text-center">
                                                <h6 class="card-title">Latest Loss</h6>
                                                <h3 class="text-danger">${latestRound.loss.toFixed(4)}</h3>
                                                <small class="text-muted">Round ${latestRound.round}</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card bg-light">
                                            <div class="card-body text-center">
                                                <h6 class="card-title">Latest Accuracy</h6>
                                                <h3 class="text-success">${(latestRound.accuracy * 100).toFixed(2)}%</h3>
                                                <small class="text-muted">Round ${latestRound.round}</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        // Create chart for the modal
                        chartHtml = `
                            <div class="mt-3">
                                <h6>Training Progress</h6>
                                <div style="height: 300px;">
                                    <canvas id="taskMetricsChart"></canvas>
                                </div>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('Error loading task metrics for modal:', error);
                }
                
                modalBody.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Task Information</h6>
                            <p><strong>ID:</strong> ${task.id}</p>
                            <p><strong>Status:</strong> <span class="badge bg-${getStatusColor(task.status)}">${task.status.toUpperCase()}</span></p>
                            <p><strong>Strategy:</strong> ${task.data.strategy_used || 'N/A'}</p>
                            <p><strong>Rounds:</strong> ${task.data.rounds_completed || 'N/A'}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Timestamps</h6>
                            ${task.data.completed_at ? `<p><strong>Completed:</strong> ${new Date(task.data.completed_at * 1000).toLocaleString()}</p>` : ''}
                            ${task.data.failed_at ? `<p><strong>Failed:</strong> ${new Date(task.data.failed_at * 1000).toLocaleString()}</p>` : ''}
                            ${task.data.error ? `<p><strong>Error:</strong> ${task.data.error}</p>` : ''}
                        </div>
                    </div>
                    ${metricsHtml}
                    ${chartHtml}
                    <div class="mt-3">
                        <h6>Details</h6>
                        <pre class="bg-light p-3 rounded">${JSON.stringify(task.data, null, 2)}</pre>
                    </div>
                `;
                
                // Render chart after modal is shown
                const taskMetrics = await loadTaskMetrics(taskId);
                if (taskMetrics && taskMetrics.length > 0) {
                    setTimeout(() => {
                        renderTaskMetricsChart('taskMetricsChart', taskMetrics);
                    }, 100);
                }
                
                const modal = new bootstrap.Modal(document.getElementById('taskModal'));
                modal.show();
            } catch (error) {
                console.error('Error loading task details:', error);
            }
        }

        async function deleteTask() {
            if (!currentTaskId) return;
            
            if (!confirm('Are you sure you want to delete this task?')) return;
            
            try {
                const response = await fetch(`/api/task/${currentTaskId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('taskModal'));
                    modal.hide();
                    loadTasks();
                    showToast('Task deleted successfully', 'success');
                }
            } catch (error) {
                console.error('Error deleting task:', error);
                showToast('Error deleting task', 'danger');
            }
        }

        async function startTask() {
            const port = document.getElementById('serverPort').value;
            
            // Check for port conflicts
            try {
                const portCheck = await fetch(`/api/check_port/${port}`);
                if (!portCheck.ok) {
                    const errorData = await portCheck.json();
                    const taskId = portCheck.headers.get('X-Task-ID');
                    if (taskId) {
                        showToast(`Port ${port} is already in use by task: ${taskId}`, 'danger');
                    } else {
                        showToast(`Port ${port} is already in use`, 'danger');
                    }
                    return;
                }
            } catch (error) {
                console.error('Error checking port:', error);
                showToast('Error checking port availability', 'danger');
                return;
            }
            
            const formData = new FormData();
            formData.append('strategy_type', document.getElementById('strategyType').value);
            formData.append('num_rounds', document.getElementById('numRounds').value);
            formData.append('metric', document.getElementById('metric').value);
            formData.append('server_port', port);
            
            if (document.getElementById('strategyType').value === 'top_k') {
                formData.append('k', document.getElementById('kValue').value);
            } else {
                formData.append('selection_ratio', document.getElementById('selectionRatio').value);
            }
            
            try {
                const response = await fetch('/api/run_task', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showToast(`Task started with ID: ${result.task_id}`, 'success');
                    loadTasks();
                } else {
                    throw new Error('Failed to start task');
                }
            } catch (error) {
                console.error('Error starting task:', error);
                showToast('Error starting task', 'danger');
            }
        }

        function updateMetricsChart(metrics) {
            const container = document.getElementById('metricsOverview');
            
            if (metrics.length === 0) {
                container.innerHTML = '<span class="text-muted">No metrics data available</span>';
                return;
            }
            
            if (metricsChart) {
                metricsChart.destroy();
            }
            
            const ctx = document.createElement('canvas');
            container.innerHTML = '';
            container.appendChild(ctx);
            
            const rounds = metrics.map(m => m.round);
            const accuracies = metrics.map(m => m.accuracy);
            const losses = metrics.map(m => m.loss);
            
            metricsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: rounds,
                    datasets: [
                        {
                            label: 'Accuracy',
                            data: accuracies,
                            borderColor: '#0d6efd',
                            backgroundColor: 'rgba(13, 110, 253, 0.1)',
                            fill: true
                        },
                        {
                            label: 'Loss',
                            data: losses,
                            borderColor: '#dc3545',
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function renderTaskMetricsChart(canvasId, metrics) {
            if (taskMetricsChart) {
                taskMetricsChart.destroy();
            }
            
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            
            const rounds = metrics.map(m => m.round);
            const accuracies = metrics.map(m => m.accuracy);
            const losses = metrics.map(m => m.loss);
            
            taskMetricsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: rounds,
                    datasets: [
                        {
                            label: 'Accuracy',
                            data: accuracies,
                            borderColor: '#0d6efd',
                            backgroundColor: 'rgba(13, 110, 253, 0.1)',
                            fill: true,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Loss',
                            data: losses,
                            borderColor: '#dc3545',
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            fill: true,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Accuracy'
                            },
                            min: 0,
                            max: 1
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Loss'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                            min: 0
                        }
                    }
                }
            });
        }

        function refreshTasks() {
            loadTasks();
            loadMetrics();
            showToast('Refreshed', 'info');
        }

        function showToast(message, type = 'info') {
            // Simple toast notification
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0`;
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            
            const toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            toastContainer.appendChild(toast);
            
            document.body.appendChild(toastContainer);
            
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            
            toast.addEventListener('hidden.bs.toast', () => {
                document.body.removeChild(toastContainer);
            });
        }

        // Comparison functions
        function updateComparisonDropdown(tasks) {
            const compareSelect = document.getElementById('compareTasks');
            compareSelect.innerHTML = '';
            
            // Only show completed tasks for comparison
            const completedTasks = tasks.filter(task => task.status === 'completed');
            
            completedTasks.forEach(task => {
                const option = document.createElement('option');
                option.value = task.id;
                option.textContent = `${task.id} - ${getStrategyDisplayName(task.data)} (${task.data.rounds_completed} rounds)`;
                compareSelect.appendChild(option);
            });
        }

        async function compareSelectedTasks() {
            const selectedOptions = Array.from(document.getElementById('compareTasks').selectedOptions);
            const metric = document.getElementById('compareMetric').value;
            
            if (selectedOptions.length < 2 || selectedOptions.length > 4) {
                showToast('Please select 2 to 4 tasks to compare', 'warning');
                return;
            }
            
            const taskIds = selectedOptions.map(option => option.value);
            const comparisonResults = document.getElementById('comparisonResults');
            
            // Show loading state
            comparisonResults.style.display = 'block';
            document.getElementById('comparisonChartContainer').innerHTML = '<div class="text-center py-5"><i class="fas fa-spinner fa-spin fa-2x"></i><p>Loading comparison data...</p></div>';
            document.getElementById('comparisonStats').innerHTML = '';
            
            try {
                // Load metrics for all selected tasks
                const metricsPromises = taskIds.map(taskId => loadTaskMetrics(taskId));
                const allMetrics = await Promise.all(metricsPromises);
                
                // Get task details for labels
                const taskDetails = [];
                for (const taskId of taskIds) {
                    const task = allTasks.find(t => t.id === taskId);
                    if (task) {
                        taskDetails.push({
                            id: taskId,
                            strategy: getStrategyDisplayName(task.data),
                            rounds: task.data.rounds_completed
                        });
                    }
                }
                
                // Render comparison chart
                renderComparisonChart(taskDetails, allMetrics, metric);
                
                // Show comparison stats
                showComparisonStats(taskDetails, allMetrics, metric);
                
            } catch (error) {
                console.error('Error comparing tasks:', error);
                showToast('Error loading comparison data', 'danger');
                comparisonResults.style.display = 'none';
            }
        }

        function renderComparisonChart(taskDetails, allMetrics, metric) {
            if (comparisonChart) {
                comparisonChart.destroy();
            }
            
            const ctx = document.createElement('canvas');
            document.getElementById('comparisonChartContainer').innerHTML = '';
            document.getElementById('comparisonChartContainer').appendChild(ctx);
            
            const datasets = [];
            const colors = ['#0d6efd', '#dc3545', '#198754', '#ffc107']; // Blue, Red, Green, Yellow
            
            taskDetails.forEach((task, index) => {
                const metrics = allMetrics[index];
                if (metrics && metrics.length > 0) {
                    const data = metrics.map(m => metric === 'accuracy' ? m.accuracy : m.loss);
                    const rounds = metrics.map(m => m.round);
                    
                    datasets.push({
                        label: `${task.strategy} (${task.id})`,
                        data: data,
                        borderColor: colors[index % colors.length],
                        backgroundColor: colors[index % colors.length] + '20',
                        fill: false,
                        tension: 0.1
                    });
                }
            });
            
            comparisonChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({length: Math.max(...allMetrics.map(m => m.length))}, (_, i) => i + 1),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: metric === 'accuracy' ? 'Accuracy' : 'Loss'
                            },
                            beginAtZero: metric === 'accuracy'
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Round'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `Comparison of ${metric} across tasks`
                        }
                    }
                }
            });
        }

        function showComparisonStats(taskDetails, allMetrics, metric) {
            const statsContainer = document.getElementById('comparisonStats');
            let statsHtml = '<h6>Comparison Statistics</h6><div class="row">';
            
            taskDetails.forEach((task, index) => {
                const metrics = allMetrics[index];
                if (metrics && metrics.length > 0) {
                    const values = metrics.map(m => metric === 'accuracy' ? m.accuracy : m.loss);
                    const finalValue = values[values.length - 1];
                    const maxValue = Math.max(...values);
                    const minValue = Math.min(...values);
                    const avgValue = values.reduce((a, b) => a + b, 0) / values.length;
                    
                    statsHtml += `
                        <div class="col-md-6 col-lg-3 mb-3">
                            <div class="card">
                                <div class="card-header">
                                    <strong>${task.strategy}</strong>
                                    <small class="text-muted d-block">${task.id}</small>
                                </div>
                                <div class="card-body">
                                    <p class="mb-1">Final ${metric}: <strong>${metric === 'accuracy' ? (finalValue * 100).toFixed(2) + '%' : finalValue.toFixed(4)}</strong></p>
                                    <p class="mb-1">Average: <strong>${metric === 'accuracy' ? (avgValue * 100).toFixed(2) + '%' : avgValue.toFixed(4)}</strong></p>
                                    <p class="mb-1">Max: <strong>${metric === 'accuracy' ? (maxValue * 100).toFixed(2) + '%' : maxValue.toFixed(4)}</strong></p>
                                    <p class="mb-0">Min: <strong>${metric === 'accuracy' ? (minValue * 100).toFixed(2) + '%' : minValue.toFixed(4)}</strong></p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });
            
            statsHtml += '</div>';
            statsContainer.innerHTML = statsHtml;
        }
    </script>
</body>
</html>
